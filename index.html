<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平板借用登記系統 - 試算表版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.01), 0 2px 4px -1px rgba(0, 0, 0, 0.01);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 導覽列 -->
    <nav class="sticky top-0 z-30 glass-nav border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-2 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="refresh-icon"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
                </div>
                <h1 class="text-lg font-bold tracking-tight">平板借用 (試算表版)</h1>
            </div>

            <div class="flex items-center bg-gray-100 p-1 rounded-xl">
                <button onclick="changeWeek(-7)" class="p-1.5 hover:bg-white rounded-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <div id="week-display" class="px-4 text-sm font-medium min-w-[120px] text-center">
                    讀取中...
                </div>
                <button onclick="changeWeek(7)" class="p-1.5 hover:bg-white rounded-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>

            <button onclick="fetchData()" class="p-2 text-gray-400 hover:text-blue-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
            </button>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="error-container" class="hidden mb-6 bg-red-50 border border-red-100 p-4 rounded-2xl flex items-center gap-3 text-red-600 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <span id="error-text">錯誤訊息</span>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-200 overflow-hidden card-shadow">
            <div class="overflow-x-auto scrollbar-hide">
                <div class="min-w-[900px]">
                    <!-- 表頭 -->
                    <div id="calendar-header" class="grid grid-cols-6 border-b border-gray-100 bg-[#FBFBFD]">
                        <div class="p-5 flex items-center justify-center border-r border-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path><path d="M21 3l-7 7"></path><path d="M3 21l7-7"></path></svg>
                        </div>
                        <!-- 星期欄位會由 JS 動態生成 -->
                    </div>

                    <!-- 節次內容 -->
                    <div id="calendar-body">
                        <!-- 由 JS 動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 彈出視窗 (Modal) -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 border border-white/20 scale-95 transition-transform duration-200" id="modal-content">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 id="modal-title" class="text-2xl font-bold tracking-tight">借用登記</h3>
                    <p id="modal-subtitle" class="text-[10px] font-bold text-gray-400 mt-1 tracking-widest uppercase"></p>
                </div>
                <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                </button>
            </div>

            <div class="space-y-6">
                <input 
                    type="text" 
                    id="grade-input"
                    placeholder="輸入班級名稱" 
                    class="w-full bg-gray-100 border-0 p-6 rounded-3xl text-center text-2xl font-black text-[#1D1D1F] outline-none focus:ring-4 focus:ring-blue-100 transition-all placeholder:text-gray-300"
                />
                
                <div id="modal-actions" class="flex flex-col gap-3">
                    <!-- 由 JS 動態切換按鈕 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定網址 ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCQS9nMgDwIDemD-1U4OBcnf-WxBI34GzuzulO9Xrs7Ezom5JFCj-sk_d4MKjxRePs9w/exec";

        // --- 狀態管理 ---
        let bookings = {};
        let currentWeekStart = getMonday(new Date());
        let selectedSlot = null;
        let isLoading = false;

        const PERIODS = [
            { id: 'morning', label: '早自習', time: '08:00 - 08:40' },
            { id: 'p1', label: '第一節', time: '08:40 - 09:20' },
            { id: 'p2', label: '第二節', time: '09:30 - 10:10' },
            { id: 'p3', label: '第三節', time: '10:30 - 11:10' },
            { id: 'p4', label: '第四節', time: '11:20 - 12:00' },
            { id: 'lunch', label: '午休', time: '12:00 - 13:30', isBreak: true },
            { id: 'p5', label: '第五節', time: '13:30 - 14:10' },
            { id: 'p6', label: '第六節', time: '14:20 - 15:00' },
            { id: 'p7', label: '第七節', time: '15:20 - 16:00' },
        ];

        // --- 工具函式 ---
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(date.setDate(diff));
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDisplayDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function getWeekDays(startDate) {
            const days = [];
            const labels = ['週一', '週二', '週三', '週四', '週五'];
            for (let i = 0; i < 5; i++) {
                const current = addDays(startDate, i);
                days.push({
                    label: labels[i],
                    dateStr: formatDateKey(current),
                    displayDate: formatDisplayDate(current)
                });
            }
            return days;
        }

        // --- 介面渲染 ---
        function renderCalendar() {
            const weekDays = getWeekDays(currentWeekStart);
            
            // 更新週次顯示
            document.getElementById('week-display').innerText = 
                `${weekDays[0].displayDate} - ${weekDays[4].displayDate}`;

            // 渲染表頭
            const header = document.getElementById('calendar-header');
            const headerSlots = header.querySelectorAll('.day-header');
            headerSlots.forEach(s => s.remove());
            
            weekDays.forEach(day => {
                const div = document.createElement('div');
                div.className = "day-header p-5 text-center border-r border-gray-100 last:border-0";
                div.innerHTML = `
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">${day.label}</div>
                    <div class="text-sm font-bold">${day.displayDate}</div>
                `;
                header.appendChild(div);
            });

            // 渲染表格內容
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';

            PERIODS.forEach(period => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-6 border-b border-gray-100 last:border-0";
                
                // 節次名稱
                const timeCol = document.createElement('div');
                timeCol.className = "p-5 bg-[#FBFBFD] border-r border-gray-100 flex flex-col items-center justify-center";
                timeCol.innerHTML = `<span class="text-xs font-bold">${period.label}</span><span class="text-[10px] text-gray-400 mt-0.5">${period.time}</span>`;
                row.appendChild(timeCol);

                if (period.isBreak) {
                    const breakCol = document.createElement('div');
                    breakCol.className = "col-span-5 bg-gray-50 flex items-center justify-center text-[10px] text-gray-400 font-medium tracking-[0.2em] uppercase";
                    breakCol.innerText = "休息時間";
                    row.appendChild(breakCol);
                } else {
                    weekDays.forEach(day => {
                        const slotKey = `${day.dateStr}-${period.id}`;
                        const booking = bookings[slotKey];
                        const slot = document.createElement('div');
                        slot.className = `h-24 p-3 border-r border-gray-100 last:border-0 cursor-pointer flex items-center justify-center transition-all duration-300 ${booking ? 'bg-red-50/50' : 'hover:bg-blue-50/40'}`;
                        
                        if (booking) {
                            slot.innerHTML = `
                                <div class="bg-white px-4 py-2.5 rounded-2xl shadow-sm border border-red-100 text-center w-full">
                                    <p class="text-xs font-bold text-red-500 truncate">${booking.grade}</p>
                                </div>
                            `;
                        } else {
                            slot.innerHTML = `<span class="text-gray-200 text-2xl font-light">+</span>`;
                        }

                        slot.onclick = () => openModal(slotKey, day.label, day.displayDate, booking);
                        row.appendChild(slot);
                    });
                }
                body.appendChild(row);
            });
        }

        // --- 資料操作 ---
        async function fetchData() {
            if (isLoading) return;
            setLoadingState(true);
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error();
                bookings = await response.json();
                showError(false);
            } catch (e) {
                showError(true, "連線失敗，請確認 Google 腳本權限設定為「所有人」。");
            } finally {
                setLoadingState(false);
                renderCalendar();
            }
        }

        async function submitAction(action) {
            const grade = document.getElementById('grade-input').value;
            if (action === 'save' && !grade) return;

            setProcessingState(true);
            try {
                // 使用 no-cors 避免跨域預檢失敗
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: action,
                        key: selectedSlot.key,
                        grade: grade
                    })
                });
                
                // 樂觀更新狀態
                if (action === 'save') {
                    bookings[selectedSlot.key] = { grade: grade };
                } else {
                    delete bookings[selectedSlot.key];
                }
                
                closeModal();
                renderCalendar();
                // 1秒後同步真實資料
                setTimeout(fetchData, 1000);
            } catch (e) {
                alert("操作失敗，請檢查網路連線");
            } finally {
                setProcessingState(false);
            }
        }

        // --- 介面互動 ---
        function changeWeek(days) {
            currentWeekStart = addDays(currentWeekStart, days);
            renderCalendar();
        }

        function openModal(key, dayLabel, displayDate, existing) {
            selectedSlot = { key, dayLabel, displayDate, existing };
            document.getElementById('modal-title').innerText = existing ? '預約資訊' : '借用登記';
            document.getElementById('modal-subtitle').innerText = `${displayDate} ${dayLabel}`;
            document.getElementById('grade-input').value = existing ? existing.grade : '';
            
            const actions = document.getElementById('modal-actions');
            if (existing) {
                actions.innerHTML = `
                    <button onclick="submitAction('delete')" id="btn-submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-5 rounded-3xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-red-100">
                        取消預約
                    </button>
                `;
            } else {
                actions.innerHTML = `
                    <button onclick="submitAction('save')" id="btn-submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-5 rounded-3xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-100">
                        確認登記
                    </button>
                `;
            }

            document.getElementById('modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95'), 10);
        }

        function closeModal() {
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('modal').classList.add('hidden');
            }, 100);
        }

        function setLoadingState(loading) {
            isLoading = loading;
            const icon = document.getElementById('refresh-icon');
            if (loading) icon.classList.add('animate-spin');
            else icon.classList.remove('animate-spin');
        }

        function setProcessingState(processing) {
            const btn = document.getElementById('btn-submit');
            if (!btn) return;
            if (processing) {
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 處理中...`;
            }
        }

        function showError(show, msg = "") {
            const container = document.getElementById('error-container');
            const text = document.getElementById('error-text');
            if (show) {
                text.innerText = msg;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // 初始化
        window.onload = fetchData;
    </script>
</body>
</html>