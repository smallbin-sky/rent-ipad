<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平板借用登記系統 - Firebase版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .transition-all { transition: all 0.3s ease; }
    </style>
</head>
<body class="min-h-screen">

    <!-- 導覽列 -->
    <nav class="sticky top-0 z-30 glass-nav border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </div>
                <h1 class="text-lg font-bold tracking-tight">平板借用 (Firebase版)</h1>
            </div>

            <div class="flex items-center bg-gray-100 p-1 rounded-xl">
                <button onclick="changeWeek(-7)" class="p-1.5 hover:bg-white rounded-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <div id="week-display" class="px-4 text-sm font-medium min-w-[120px] text-center">載入中...</div>
                <button onclick="changeWeek(7)" class="p-1.5 hover:bg-white rounded-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>

            <div id="auth-status" class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded transition-all">檢查中...</div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- 錯誤提示區塊 (如果已啟用匿名登入，這會自動消失) -->
        <div id="setup-notice" class="hidden mb-8 bg-amber-50 border border-amber-200 p-6 rounded-3xl text-amber-800">
            <div class="flex items-start gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-1 flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                <div>
                    <h2 class="font-bold text-lg mb-1">尚未檢測到匿名登入</h2>
                    <p class="text-sm opacity-90 leading-relaxed">
                        系統目前無法驗證身份。請確認您已在 Firebase Console 開啟<strong>「匿名 (Anonymous)」</strong>驗證方式。
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto scrollbar-hide">
                <div class="min-w-[900px]">
                    <div id="calendar-header" class="grid grid-cols-6 border-b border-gray-100 bg-[#FBFBFD]">
                        <div class="p-5 flex items-center justify-center border-r border-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                    </div>
                    <div id="calendar-body"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- 彈出視窗 -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 border border-white/20 scale-95 transition-transform duration-200" id="modal-content">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 id="modal-title" class="text-2xl font-bold tracking-tight">借用登記</h3>
                    <p id="modal-subtitle" class="text-[10px] font-bold text-gray-400 mt-1 tracking-widest uppercase"></p>
                </div>
                <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-6">
                <input type="text" id="grade-input" placeholder="輸入班級名稱" class="w-full bg-gray-100 border-0 p-6 rounded-3xl text-center text-2xl font-black outline-none focus:ring-4 focus:ring-blue-100 transition-all">
                <div id="modal-actions" class="flex flex-col gap-3"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIv8NT_1jvEf4gZKCuCqT_RtpncbDc-no",
            authDomain: "rent-ipad.firebaseapp.com",
            projectId: "rent-ipad",
            storageBucket: "rent-ipad.firebasestorage.app",
            messagingSenderId: "794585268818",
            appId: "1:794585268818:web:d85762b985eb483862158b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "rent-ipad-system"; 

        let bookings = {};
        let currentWeekStart = getMonday(new Date());
        let selectedSlot = null;
        let currentUser = null;

        const PERIODS = [
            { id: 'morning', label: '早自習', time: '08:00 - 08:40' },
            { id: 'p1', label: '第一節', time: '08:40 - 09:20' },
            { id: 'p2', label: '第二節', time: '09:30 - 10:10' },
            { id: 'p3', label: '第三節', time: '10:30 - 11:10' },
            { id: 'p4', label: '第四節', time: '11:20 - 12:00' },
            { id: 'lunch', label: '午休', time: '12:00 - 13:30', isBreak: true },
            { id: 'p5', label: '第五節', time: '13:30 - 14:10' },
            { id: 'p6', label: '第六節', time: '14:20 - 15:00' },
            { id: 'p7', label: '第七節', time: '15:20 - 16:00' },
        ];

        // 初始化應用
        async function initApp() {
            // 監聽登入狀態
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                const statusEl = document.getElementById('auth-status');
                const noticeEl = document.getElementById('setup-notice');
                
                if (user) {
                    statusEl.innerText = "已連線";
                    statusEl.className = "text-[10px] font-bold text-green-500 bg-green-50 px-2 py-1 rounded transition-all";
                    noticeEl.classList.add('hidden');
                    startSync();
                } else {
                    statusEl.innerText = "未登入";
                    statusEl.className = "text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded transition-all";
                }
            });

            // 執行登入
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth Error:", e.code);
                if (e.code === 'auth/configuration-not-found') {
                    document.getElementById('setup-notice').classList.remove('hidden');
                    document.getElementById('auth-status').innerText = "配置錯誤";
                    document.getElementById('auth-status').className = "text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded transition-all";
                }
            }
        }

        function startSync() {
            const publicDataCol = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
            onSnapshot(publicDataCol, (snapshot) => {
                bookings = {};
                snapshot.forEach(doc => {
                    bookings[doc.id] = doc.data();
                });
                renderCalendar();
            }, (err) => {
                console.error("Firestore Sync Error:", err);
            });
        }

        window.submitAction = async (action) => {
            if (!currentUser) {
                alert("尚未登入，請重新整理頁面。");
                return;
            }
            
            const grade = document.getElementById('grade-input').value;
            if (action === 'save' && !grade) return;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', selectedSlot.key);
            
            try {
                if (action === 'save') {
                    await setDoc(docRef, { grade, timestamp: new Date().getTime(), userId: currentUser.uid });
                } else {
                    await deleteDoc(docRef);
                }
                closeModal();
            } catch (e) {
                alert("權限錯誤：請確認 Firebase Firestore 的 Rules 是否已開放讀寫。");
            }
        };

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(date.setDate(diff));
        }

        window.changeWeek = (days) => {
            currentWeekStart = new Date(currentWeekStart.setDate(currentWeekStart.getDate() + days));
            renderCalendar();
        };

        window.openModal = (key, dayLabel, displayDate, existing) => {
            selectedSlot = { key };
            document.getElementById('modal-title').innerText = existing ? '預約資訊' : '借用登記';
            document.getElementById('modal-subtitle').innerText = `${displayDate} ${dayLabel}`;
            document.getElementById('grade-input').value = existing ? existing.grade : '';
            
            const actions = document.getElementById('modal-actions');
            actions.innerHTML = existing 
                ? `<button onclick="submitAction('delete')" class="w-full bg-red-500 text-white py-5 rounded-3xl font-bold shadow-lg shadow-red-100 active:scale-95 transition-transform">取消預約</button>`
                : `<button onclick="submitAction('save')" class="w-full bg-blue-500 text-white py-5 rounded-3xl font-bold shadow-lg shadow-blue-100 active:scale-95 transition-transform">確認登記</button>`;

            document.getElementById('modal').classList.remove('hidden');
        }

        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        function renderCalendar() {
            const labels = ['週一', '週二', '週三', '週四', '週五'];
            const weekDays = [];
            for(let i=0; i<5; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDays.push({
                    label: labels[i],
                    dateStr: d.toISOString().split('T')[0],
                    displayDate: `${d.getMonth()+1}/${d.getDate()}`
                });
            }

            document.getElementById('week-display').innerText = `${weekDays[0].displayDate} - ${weekDays[4].displayDate}`;

            const header = document.getElementById('calendar-header');
            header.innerHTML = '<div class="p-5 border-r border-gray-100"></div>';
            weekDays.forEach(day => {
                header.innerHTML += `<div class="p-5 text-center border-r border-gray-100 last:border-0"><div class="text-[10px] font-bold text-gray-400 uppercase mb-1">${day.label}</div><div class="text-sm font-bold">${day.displayDate}</div></div>`;
            });

            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            PERIODS.forEach(period => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-6 border-b border-gray-100 last:border-0";
                row.innerHTML = `<div class="p-5 bg-[#FBFBFD] border-r border-gray-100 flex flex-col items-center justify-center text-center"><span class="text-xs font-bold">${period.label}</span><span class="text-[10px] text-gray-400">${period.time}</span></div>`;

                if (period.isBreak) {
                    row.innerHTML += `<div class="col-span-5 bg-gray-50 flex items-center justify-center text-[10px] text-gray-400 tracking-widest uppercase">休息時間</div>`;
                } else {
                    weekDays.forEach(day => {
                        const key = `${day.dateStr}-${period.id}`;
                        const b = bookings[key];
                        const cell = document.createElement('div');
                        cell.className = `h-24 p-3 border-r border-gray-100 last:border-0 cursor-pointer flex items-center justify-center transition-all ${b ? 'bg-red-50/30' : 'hover:bg-blue-50/30'}`;
                        cell.innerHTML = b 
                            ? `<div class="bg-white px-3 py-2 rounded-2xl shadow-sm border border-red-50 w-full text-center truncate text-xs font-bold text-red-500">${b.grade}</div>`
                            : `<span class="text-gray-200 text-2xl font-light">+</span>`;
                        cell.onclick = () => openModal(key, day.label, day.displayDate, b);
                        row.appendChild(cell);
                    });
                }
                body.appendChild(row);
            });
        }

        initApp();
    </script>
</body>
</html>