<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平板車借用登記系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase App (Compat version for easier browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .mac-card { box-shadow: 0 20px 50px rgba(0,0,0,0.05); border: 1px solid rgba(210, 210, 213, 0.3); }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-[#F5F5F7]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 安全取得環境變數 ---
        const getFirebaseConfig = () => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            } catch (e) {
                return null;
            }
        };

        const config = getFirebaseConfig();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-app';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- 工具函式 ---
        const getMonday = (d) => {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(date.setDate(diff));
        };
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };
        const formatDateKey = (date) => date.toISOString().split('T')[0];
        const formatDisplayDate = (date) => `${date.getMonth() + 1}/${date.getDate()}`;
        const getWeekDays = (startDate) => {
            const days = [];
            for (let i = 0; i < 5; i++) {
                const current = addDays(startDate, i);
                days.push({
                    id: i,
                    label: ['週一', '週二', '週三', '週四', '週五'][i],
                    dateStr: formatDateKey(current),
                    displayDate: formatDisplayDate(current)
                });
            }
            return days;
        };

        const PERIODS = [
            { id: 'morning', label: '早自習', time: '08:00 - 08:40' },
            { id: 'p1', label: '第一節', time: '08:40 - 09:20' },
            { id: 'p2', label: '第二節', time: '09:30 - 10:10' },
            { id: 'p3', label: '第三節', time: '10:30 - 11:10' },
            { id: 'p4', label: '第四節', time: '11:20 - 12:00' },
            { id: 'lunch', label: '午休', time: '12:00 - 13:30', isBreak: true },
            { id: 'p5', label: '第五節', time: '13:30 - 14:10' },
            { id: 'p6', label: '第六節', time: '14:20 - 15:00' },
            { id: 'p7', label: '第七節', time: '15:20 - 16:00' },
        ];

        const Icon = ({ name, className = "w-5 h-5" }) => (
            <i data-lucide={name} className={className}></i>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [bookings, setBookings] = useState({});
            const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [formData, setFormData] = useState({ grade: '' });
            const [isProcessing, setIsProcessing] = useState(false);
            const [isDemo, setIsDemo] = useState(false);

            useEffect(() => {
                const initFirebase = async () => {
                    // 如果沒有 config，進入演示模式
                    if (!config || !window.firebase) {
                        console.warn("未偵測到 Firebase 設定或庫，進入演示模式");
                        setIsDemo(true);
                        setUser({ uid: 'guest-user' });
                        return;
                    }

                    try {
                        // 使用 compat 版本避免 require 錯誤
                        const firebase = window.firebase;
                        if (!firebase.apps.length) {
                            firebase.initializeApp(config);
                        }
                        
                        const auth = firebase.auth();
                        const firestore = firebase.firestore();
                        setDb(firestore);

                        // 登入邏輯
                        if (initialToken) {
                            await auth.signInWithCustomToken(initialToken);
                        } else {
                            await auth.signInAnonymously();
                        }

                        auth.onAuthStateChanged((u) => {
                            setUser(u);
                            if (u) {
                                // 修正路徑以符合規範
                                const path = `artifacts/${appId}/public/data/bookings`;
                                firestore.collection(path).onSnapshot((snapshot) => {
                                    const data = {};
                                    snapshot.forEach(doc => { data[doc.id] = doc.data(); });
                                    setBookings(data);
                                }, (err) => {
                                    console.error("Firestore Error:", err);
                                });
                            }
                        });
                    } catch (error) {
                        console.error("Firebase 初始化失敗:", error);
                        setIsDemo(true);
                        setUser({ uid: 'demo-user' });
                    }
                };

                initFirebase();
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const weekDays = getWeekDays(currentWeekStart);

            const handleSave = async () => {
                if (!formData.grade) return;
                setIsProcessing(true);
                
                if (isDemo) {
                    setBookings(prev => ({ ...prev, [selectedSlot.key]: { grade: formData.grade } }));
                    setModalOpen(false);
                    setIsProcessing(false);
                    return;
                }

                try {
                    const path = `artifacts/${appId}/public/data/bookings`;
                    await db.collection(path).doc(selectedSlot.key).set({
                        grade: formData.grade,
                        timestamp: Date.now(),
                        userId: user.uid
                    });
                    setModalOpen(false);
                } catch (e) {
                    console.error("Save error:", e);
                } finally { setIsProcessing(false); }
            };

            const handleDelete = async () => {
                setIsProcessing(true);
                if (isDemo) {
                    const newBookings = { ...bookings };
                    delete newBookings[selectedSlot.key];
                    setBookings(newBookings);
                    setModalOpen(false);
                    setIsProcessing(false);
                    return;
                }

                try {
                    const path = `artifacts/${appId}/public/data/bookings`;
                    await db.collection(path).doc(selectedSlot.key).delete();
                    setModalOpen(false);
                } catch (e) {
                    console.error("Delete error:", e);
                } finally { setIsProcessing(false); }
            };

            return (
                <div className="min-h-screen pb-12">
                    <nav className="sticky top-0 z-30 glass-effect border-b border-[#D2D2D7]/50 px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 rounded-xl shadow-md">
                                <Icon name="tablet" className="text-white w-5 h-5" />
                            </div>
                            <h1 className="text-lg font-semibold tracking-tight text-[#1D1D1F]">平板借用管理</h1>
                        </div>
                        
                        <div className="flex items-center bg-[#E8E8ED]/60 p-1 rounded-xl">
                            <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, -7))} className="p-1.5 hover:bg-white rounded-lg transition-all active:scale-90">
                                <Icon name="chevron-left" className="w-4 h-4" />
                            </button>
                            <div className="px-4 text-xs font-bold min-w-[120px] text-center text-[#1D1D1F]">
                                {formatDisplayDate(currentWeekStart)} - {formatDisplayDate(addDays(currentWeekStart, 4))}
                            </div>
                            <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, 7))} className="p-1.5 hover:bg-white rounded-lg transition-all active:scale-90">
                                <Icon name="chevron-right" className="w-4 h-4" />
                            </button>
                        </div>

                        <div className="flex items-center gap-4">
                            {isDemo && <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-bold">預覽模式</span>}
                            <div className={`w-2.5 h-2.5 rounded-full ${user ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]' : 'bg-slate-300'}`}></div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-[2.5rem] mac-card overflow-hidden">
                            <div className="overflow-x-auto scrollbar-hide">
                                <div className="min-w-[900px]">
                                    <div className="grid grid-cols-6 border-b border-[#F5F5F7] bg-[#FBFBFD]">
                                        <div className="p-5 flex items-center justify-center border-r border-[#F5F5F7]">
                                            <Icon name="maximize-2" className="text-[#86868B] w-4 h-4" />
                                        </div>
                                        {weekDays.map(day => (
                                            <div key={day.dateStr} className="p-5 text-center border-r border-[#F5F5F7] last:border-0">
                                                <div className="text-[10px] font-bold text-[#86868B] uppercase tracking-wider mb-1">{day.label}</div>
                                                <div className="text-sm font-bold text-[#1D1D1F]">{day.displayDate}</div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {PERIODS.map(period => (
                                        <div key={period.id} className="grid grid-cols-6 border-b border-[#F5F5F7] last:border-0 group">
                                            <div className="p-5 bg-[#FBFBFD] border-r border-[#F5F5F7] flex flex-col items-center justify-center">
                                                <span className="text-xs font-bold text-[#1D1D1F]">{period.label}</span>
                                                <span className="text-[10px] text-[#86868B] mt-0.5">{period.time}</span>
                                            </div>
                                            {period.isBreak ? (
                                                <div className="col-span-5 bg-[#F5F5F7]/30 flex items-center justify-center text-[10px] text-[#86868B] font-medium tracking-[0.2em] uppercase">休息時間</div>
                                            ) : (
                                                weekDays.map(day => {
                                                    const key = `${day.dateStr}-${period.id}`;
                                                    const booking = bookings[key];
                                                    return (
                                                        <div key={key} onClick={() => {
                                                            setSelectedSlot({ key, displayDate: day.displayDate, dayLabel: day.label, periodLabel: period.label, existing: booking });
                                                            setFormData(booking || { grade: '' });
                                                            setModalOpen(true);
                                                        }} className={`h-24 p-3 border-r border-[#F5F5F7] last:border-0 cursor-pointer flex items-center justify-center transition-all duration-300 ${booking ? 'bg-[#FF3B30]/5 hover:bg-[#FF3B30]/10' : 'bg-white hover:bg-blue-50/40'}`}>
                                                            {booking ? (
                                                                <div className="bg-white px-4 py-2.5 rounded-[1.25rem] shadow-sm border border-[#FF3B30]/10 text-center w-full animate-in">
                                                                    <p className="text-xs font-bold text-[#FF3B30] truncate">{booking.grade}</p>
                                                                </div>
                                                            ) : (
                                                                <span className="text-[#86868B]/10 group-hover:text-blue-400 text-2xl font-light">+</span>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>

                    {modalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#1D1D1F]/20 backdrop-blur-sm">
                            <div className="bg-white/95 backdrop-blur-xl rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 border border-white/20 animate-in">
                                <div className="flex justify-between items-start mb-8">
                                    <div>
                                        <h3 className="text-2xl font-bold text-[#1D1D1F] tracking-tight">{selectedSlot.existing ? '預約詳情' : '借用登記'}</h3>
                                        <p className="text-[10px] font-bold text-[#86868B] mt-1 tracking-wider uppercase">
                                            {selectedSlot.displayDate} {selectedSlot.dayLabel} • {selectedSlot.periodLabel}
                                        </p>
                                    </div>
                                    <button onClick={() => setModalOpen(false)} className="bg-[#F5F5F7] p-2 rounded-full hover:bg-[#E8E8ED] transition-colors">
                                        <Icon name="x-circle" className="w-5 h-5 text-[#86868B]" />
                                    </button>
                                </div>
                                
                                <div className="space-y-6">
                                    <input 
                                        className="w-full bg-[#F5F5F7] p-6 rounded-3xl text-center text-2xl font-black text-[#1D1D1F] outline-none focus:ring-4 focus:ring-blue-100 transition-all placeholder:text-[#86868B]/30"
                                        placeholder="輸入班級名稱"
                                        value={formData.grade}
                                        onChange={e => setFormData({grade: e.target.value})}
                                        disabled={isProcessing || selectedSlot.existing}
                                        autoFocus
                                    />
                                    
                                    {selectedSlot.existing ? (
                                        <button onClick={handleDelete} disabled={isProcessing} className="w-full bg-[#FF3B30] hover:bg-[#D70015] text-white py-5 rounded-3xl font-bold transition-all flex items-center justify-center gap-2">
                                            {isProcessing ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="x-circle" />}
                                            取消登記
                                        </button>
                                    ) : (
                                        <button onClick={handleSave} disabled={isProcessing} className="w-full bg-[#007AFF] hover:bg-[#0062CC] text-white py-5 rounded-3xl font-bold transition-all flex items-center justify-center gap-2">
                                            {isProcessing ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="check-circle" />}
                                            確認登記
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>